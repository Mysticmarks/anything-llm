name: anythingllm-integration

services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    ports:
      - "6379:6379"
    networks:
      - integration

  qdrant:
    image: qdrant/qdrant:v1.11.2
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q localhost:6333/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    ports:
      - "6333:6333"
    networks:
      - integration

  litellm-mock:
    image: node:20-alpine
    working_dir: /mocks
    command: ["node", "server.js"]
    volumes:
      - ../docker/mocks/litellm-mock:/mocks:ro
    environment:
      PORT: 8001
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q localhost:8001/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    networks:
      - integration

  api:
    build:
      context: ../.
      dockerfile: ./docker/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      litellm-mock:
        condition: service_healthy
    environment:
      NODE_ENV: test
      SERVER_PORT: 3001
      STORAGE_DIR: /app/server/storage
      DATABASE_URL: file:/app/server/storage/anythingllm.db
      JWT_SECRET: integration-jwt
      SIG_KEY: integration-signature-key-32-chars-min
      SIG_SALT: integration-signature-salt-32-chars
      AUTH_TOKEN: integration-secret
      DISABLE_TELEMETRY: "true"
      VECTOR_DB: qdrant
      QDRANT_ENDPOINT: http://qdrant:6333
      REDIS_URL: redis://redis:6379
      COLLECTOR_PORT: 8888
      LLM_PROVIDER: litellm
      LITE_LLM_BASE_PATH: http://litellm-mock:8001
      LITE_LLM_MODEL_PREF: integration-mock
      LITE_LLM_MODEL_TOKEN_LIMIT: "4096"
      USE_STACK_MANAGER: "false"
      ENABLE_HTTP_LOGGER: "false"
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"
      SKIP_FRONTEND_BUILD: "true"
      DISABLE_FRONTEND_PROCESS: "true"
    ports:
      - "3001:3001"
    volumes:
      - ../server/storage:/app/server/storage
      - ../collector/hotdir:/app/collector/hotdir
      - ../collector/outputs:/app/collector/outputs
    entrypoint: ["/bin/bash", "-lc", "cd /app/server && npx prisma generate --schema=./prisma/schema.prisma && npx prisma migrate deploy --schema=./prisma/schema.prisma && node index.js"]
    networks:
      - integration

  collector:
    build:
      context: ../.
      dockerfile: ./docker/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      api:
        condition: service_started
    environment:
      NODE_ENV: test
      COLLECTOR_PORT: 8888
      AUTH_TOKEN: integration-secret
      DISABLE_TELEMETRY: "true"
      STORAGE_DIR: /app/server/storage
      USE_STACK_MANAGER: "false"
    volumes:
      - ../collector/hotdir:/app/collector/hotdir
      - ../collector/outputs:/app/collector/outputs
    entrypoint: ["/bin/bash", "-lc", "cd /app/collector && node index.js"]
    ports:
      - "8888:8888"
    networks:
      - integration

networks:
  integration:
    driver: bridge
